<section class="section">
  <div class="container calendar-detail">
    <div class="header-row">
      <button class="btn btn-ghost" (click)="goBack()">← Back</button>
      <h1>{{ isNew ? '➕ New Event' : '✏️ Edit Event' }}</h1>
    </div>

    <!-- Form renders once loading is done -->
    <form (ngSubmit)="saveEvent()" *ngIf="!loading">
      <!-- Event fields -->
      <label class="field-label">Name</label>
      <input class="input" type="text" [(ngModel)]="event.name" name="name" required />

      <label class="field-label">Date</label>
      <input class="input" type="date" [(ngModel)]="event.event_date" name="date" required />

      <label class="field-label">Start Time</label>
      <input class="input" type="time" [(ngModel)]="event.start_time" name="start_time" required />

      <label class="field-label">End Time</label>
      <input class="input" type="time" [(ngModel)]="event.end_time" name="end_time" required />

      <label class="field-label">Type</label>
      <select class="select" [(ngModel)]="event.type" name="type" required>
        <option value="service">Service</option>
        <option value="rehearsal">Rehearsal</option>
        <option value="other">Other</option>
      </select>

      <label class="field-label">Setlist</label>
      <select class="select" [(ngModel)]="event.setlist_id" name="setlist">
        <option [ngValue]="null">— None —</option>
        <option *ngFor="let s of setlists" [ngValue]="s.id">{{ s.name }}</option>
      </select>
      <a routerLink="/setlists" class="small-link">➕ Create new setlist</a>

      <label class="field-label">Notes</label>
      <textarea class="input" rows="3" [(ngModel)]="event.notes" name="notes"></textarea>

      <!-- Members -->
      <label class="field-label">Assign Members</label>
      <div class="member-list">
        <div *ngFor="let m of members" class="member-row">
          <span>{{ m.name }} ({{ m.role || '—' }})</span>
          <button
            type="button"
            class="btn btn-small"
            [ngClass]="isMemberAssigned(m.id) ? 'btn-secondary' : 'btn-ghost'"
            (click)="toggleMember(m.id)"
          >
            {{ isMemberAssigned(m.id) ? 'Remove' : 'Add' }}
          </button>
        </div>
      </div>

      <!-- Google Calendar Sync Status -->
      <div class="google-sync">
        <label class="field-label">Google Calendar</label>
        <p *ngIf="event.google_event_id; else notSynced" class="synced">
          ☁ Synced with Google Calendar
          <small>ID: {{ event.google_event_id }}</small>
        </p>
        <ng-template #notSynced>
          <p class="not-synced">⚠ Not yet synced to Google Calendar</p>
        </ng-template>
      </div>

      <div class="actions">
        <button type="submit" class="btn btn-primary w-100">
          {{ isNew ? 'Create Event' : 'Save Changes' }}
        </button>
        <button type="button" class="btn btn-ghost w-100" (click)="goBack()">Cancel</button>
        <button
          *ngIf="!isNew"
          type="button"
          class="btn btn-danger w-100"
          (click)="deleteEvent()"
        >
          🗑 Delete Event
        </button>
      </div>
    </form>

    <div *ngIf="loading" class="muted">Loading…</div>
  </div>
</section>
