<section class="section">
  <div class="container song-detail">

    <!-- Mini Topbar -->
    <div class="topbar">
      <button class="btn btn-ghost back-btn" (click)="goBack()" aria-label="Go back to previous page">
        ‚Üê Back
      </button>
    </div>

    <!-- Header + action -->
    <div class="header-row">
      <div>
        <h1>{{ song?.title }}</h1>
        <p class="muted" *ngIf="song?.artist">By {{ song.artist }}</p>
      </div>
      <div class="actions">
        <button class="btn btn-primary" (click)="openAddToSetlist()">‚ûï Add to Setlist</button>
      </div>
    </div>

    <!-- Authors -->
    <div class="meta" *ngIf="song?.authors?.length">
      <h3>Authors</h3>
      <p>{{ song.authors.join(', ') }}</p>
    </div>

    <!-- Info -->
    <div class="meta-grid">
      <div><strong>Tempo:</strong> {{ song?.tempo || '‚Äî' }}</div>
      <div><strong>Theme:</strong> {{ song?.theme || '‚Äî' }}</div>
      <div><strong>Time Signature:</strong> {{ song?.time_signature || '‚Äî' }}</div>
      <div><strong>Meter:</strong> {{ song?.meter || '‚Äî' }}</div>
      <div><strong>Style:</strong> {{ song?.style || '‚Äî' }}</div>
    </div>

    <!-- Song Map -->
    <div class="meta" *ngIf="song?.song_map?.length">
      <h3>Song Map</h3>
      <p>{{ song.song_map }}</p>
    </div>

    <!-- Lyrics -->
    <div class="lyrics" *ngIf="song?.lyrics">
      <h3>Lyrics</h3>
      <pre>{{ song.lyrics?.default || 'No lyrics available' }}</pre>
    </div>

    <!-- Audio Player -->
    <div class="audio-player" *ngIf="song?.audio_url">
      <h3>üéß Listen</h3>
      <audio controls [src]="song.audio_url"></audio>
    </div>
  </div>

  <!-- Add to Setlist Modal -->
  <div class="modal-backdrop" *ngIf="isModalOpen" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>Add ‚Äú{{ song?.title }}‚Äù to a setlist</h3>

      <div class="mode-toggle">
        <button class="mode-btn" [class.active]="!creatingNew" (click)="creatingNew = false">Choose Existing</button>
        <button class="mode-btn" [class.active]="creatingNew" (click)="creatingNew = true">Create New</button>
      </div>

      <!-- Existing Setlist -->
      <div *ngIf="!creatingNew">
        <label class="field-label">Select a setlist</label>
        <select class="select" [(ngModel)]="selectedSetlistId">
          <option [ngValue]="null" disabled>Select‚Ä¶</option>
          <option *ngFor="let s of setlists" [ngValue]="s.id">{{ s.name }}</option>
        </select>
        <button class="btn btn-primary w-100"
                [disabled]="!selectedSetlistId || actionLoading"
                (click)="addToExisting()">
          {{ actionLoading ? 'Adding‚Ä¶' : 'Add to Setlist' }}
        </button>
      </div>

      <!-- New Setlist (no date asked) -->
      <div *ngIf="creatingNew">
        <label class="field-label">New setlist name</label>
        <input class="input" type="text" [(ngModel)]="newSetlistName" placeholder="e.g., March 9 Sunday AM" />
        <button class="btn btn-primary w-100"
                [disabled]="!newSetlistName.trim() || actionLoading"
                (click)="createSetlistAndAdd()">
          {{ actionLoading ? 'Creating‚Ä¶' : 'Create & Add' }}
        </button>
      </div>

      <button class="btn btn-ghost w-100" (click)="closeModal()">Cancel</button>

      <p class="muted small" *ngIf="errorMsg">{{ errorMsg }}</p>
      <p class="success small" *ngIf="successMsg">{{ successMsg }}</p>
    </div>
  </div>
</section>

