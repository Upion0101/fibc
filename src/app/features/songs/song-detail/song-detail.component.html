<section class="section">
  <div class="container song-detail">

    <!-- Mini Topbar -->
    <div class="topbar">
      <button class="btn btn-ghost back-btn" (click)="goBack()" aria-label="Go back to previous page">
        ‚Üê Back
      </button>
    </div>

    <!-- Header + action -->
    <div class="header-row">
      <div>
        <h1>{{ song?.title }}</h1>
        <p class="muted" *ngIf="song?.artist">By {{ song.artist }}</p>
      </div>
      <div class="actions">
        <button class="btn btn-primary" (click)="openAddToSetlist()">‚ûï Add to Setlist</button>

        <!-- Delete shows ONLY for custom songs -->
        <button
          *ngIf="song?.is_custom"
          class="btn btn-danger"
          (click)="isDeleteOpen = true"
          aria-label="Delete this custom song"
          title="Delete this custom song (removes files and DB row)"
        >
          üóë Delete
        </button>
      </div>
    </div>

    <!-- Authors -->
    <div class="meta" *ngIf="song?.authors?.length">
      <h3>Authors</h3>
      <p>{{ song.authors.join(', ') }}</p>
    </div>

    <!-- Info -->
    <div class="meta-grid">
      <div><strong>Tempo:</strong> {{ song?.tempo || '‚Äî' }}</div>
      <div><strong>Theme:</strong> {{ song?.theme || '‚Äî' }}</div>
      <div><strong>Time Signature:</strong> {{ song?.time_signature || '‚Äî' }}</div>
      <div><strong>Meter:</strong> {{ song?.meter || '‚Äî' }}</div>
      <div><strong>Style:</strong> {{ song?.style || '‚Äî' }}</div>
      <div><strong>Original Key:</strong> {{ originalKey }}</div>
    </div>

    <!-- Song Map -->
    <div class="meta" *ngIf="song?.song_map?.length">
      <h3>Song Map</h3>
      <p>{{ song.song_map }}</p>
    </div>

    <!-- Transpose / Key controls -->
    <div class="transpose-bar" *ngIf="hasLyrics">
      <label for="keySelect"><strong>Key:</strong></label>
      <select
        id="keySelect"
        class="select"
        [(ngModel)]="displayKey"
        (ngModelChange)="onKeyChange($event)"
        aria-label="Choose display key"
      >
        <option *ngFor="let k of keys" [ngValue]="k">{{ k }}</option>
      </select>

      <span class="muted" *ngIf="!isNN">
        Showing in {{ displayKey }} (original: {{ originalKey }})
        <ng-container *ngIf="enharmonicLabel(displayKey) as aka">
          ¬∑ <em>aka {{ aka }}</em>
        </ng-container>
      </span>

      <span class="muted" *ngIf="isNN">
        Showing in <strong>Nashville Numbers</strong> (relative to {{ originalKey }})
      </span>
    </div>

    <!-- Lyrics -->
    <div class="lyrics" *ngIf="hasLyrics">
      <h3>Lyrics</h3>

      <!-- Plain string -->
      <pre *ngIf="isString(transposedLyrics)">{{ transposedLyrics }}</pre>

      <!-- Array of lines -->
      <ng-container *ngIf="isArray(transposedLyrics)">
        <pre *ngFor="let line of asArray(transposedLyrics)">{{ line }}</pre>
      </ng-container>

      <!-- Sectioned object -->
      <ng-container *ngIf="isObject(transposedLyrics)">
        <div class="section-block" *ngFor="let sec of (transposedLyrics | keyvalue)">
          <h4 class="section-title">{{ sec.key }}</h4>
          <pre *ngIf="!isArray(sec.value)">{{ sec.value }}</pre>
          <ng-container *ngIf="isArray(sec.value)">
            <pre *ngFor="let line of asArray(sec.value)">{{ line }}</pre>
          </ng-container>
        </div>
      </ng-container>
    </div>

    <!-- Audio Player -->
    <div class="audio-player" *ngIf="song?.audio_url">
      <h3>üéß Listen</h3>
      <audio controls [src]="song.audio_url"></audio>
    </div>

    <!-- PDF Chart -->
    <div class="meta" *ngIf="song?.pdf_url">
      <h3>üìÑ Chart</h3>
      <a [href]="song.pdf_url" target="_blank" rel="noopener" class="btn btn-secondary">Open PDF</a>
    </div>

    <!-- Reference Links -->
    <div class="meta" *ngIf="song?.reference_links?.length">
      <h3>üîó Reference Links</h3>
      <ul>
        <li *ngFor="let link of song.reference_links">
          <a [href]="link" target="_blank" rel="noopener">{{ link }}</a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Add to Setlist Modal -->
  <div class="modal-backdrop" *ngIf="isModalOpen" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>Add ‚Äú{{ song?.title }}‚Äù to a setlist</h3>

      <div class="mode-toggle">
        <button class="mode-btn" [class.active]="!creatingNew" (click)="creatingNew = false">Choose Existing</button>
        <button class="mode-btn" [class.active]="creatingNew" (click)="creatingNew = true">Create New</button>
      </div>

      <div *ngIf="!creatingNew">
        <label class="field-label">Select a setlist</label>
        <select class="select" [(ngModel)]="selectedSetlistId">
          <option [ngValue]="null" disabled>Select‚Ä¶</option>
          <option *ngFor="let s of setlists" [ngValue]="s.id">{{ s.name }}</option>
        </select>
        <button class="btn btn-primary w-100"
                [disabled]="!selectedSetlistId || actionLoading"
                (click)="addToExisting()">
          {{ actionLoading ? 'Adding‚Ä¶' : 'Add to Setlist' }}
        </button>
      </div>

      <div *ngIf="creatingNew">
        <label class="field-label">New setlist name</label>
        <input class="input" type="text" [(ngModel)]="newSetlistName" placeholder="e.g., March 9 Sunday AM" />
        <button class="btn btn-primary w-100"
                [disabled]="!newSetlistName.trim() || actionLoading"
                (click)="createSetlistAndAdd()">
          {{ actionLoading ? 'Creating‚Ä¶' : 'Create & Add' }}
        </button>
      </div>

      <button class="btn btn-ghost w-100" (click)="closeModal()">Cancel</button>

      <p class="muted small" *ngIf="errorMsg">{{ errorMsg }}</p>
      <p class="success small" *ngIf="successMsg">{{ successMsg }}</p>
    </div>
  </div>

  <!-- Delete Confirmation Modal (only opens when user clicks Delete) -->
  <div class="modal-backdrop" *ngIf="isDeleteOpen" (click)="isDeleteOpen = false">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>Delete ‚Äú{{ song?.title }}‚Äù?</h3>
      <p class="muted">
        This will permanently remove the song and its files (audio/PDF/manifest). This action cannot be undone.
      </p>

      <div class="row gap">
        <button class="btn btn-ghost w-50" (click)="isDeleteOpen = false" [disabled]="deleteLoading">Cancel</button>
        <button class="btn btn-danger w-50" (click)="confirmDelete()" [disabled]="deleteLoading">
          {{ deleteLoading ? 'Deleting‚Ä¶' : 'Delete' }}
        </button>
      </div>

      <p class="muted small" *ngIf="deleteError">{{ deleteError }}</p>
    </div>
  </div>
</section>
